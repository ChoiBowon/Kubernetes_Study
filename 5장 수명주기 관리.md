# 5장 수명주기 관리 패턴  
### Managed Lifecycle - 수명주기 관리 패턴  

핵심 : 수명주기 관리

* 컨테이너화된 애플리케이션은 관리 플랫폼에 의해 생성된 이벤트를 받아서 그에 맞춰 수명주기를 조절해야한다.

- - - -
**문제** 
1. 정책 및 외부 요인에 따라 애플리케이션의 시작 중지 결정  
2. 어떤 이벤트가 중요하고 그 이벤트에 어떻게 반응할 것인지를 결정할 필요 있음 
3. 프로세스 상태 확인만으로는 애플리케이션이 정상상태인지 확인하는데 불충분  


**해결책**
1. 프로세스를 실행하고 중지하는 데에 프로세스 모델만 사용하는 것은 충분하지 않음  
2. 세분화된상호작용과 수명주기관리 기능필요 
3. 5장에서 설명하는 이벤트와 훅은 모두 개별 컨테이너 레벨에 적용됨  

- - - -
## 1. 시그텀 - SIGTERM
* 시그텀 신호 - 쿠버네티스가 갑작스러운 시그킬 신호를 보내기 전에 컨테이너가 깨끗하게 종료될 수 있도록 보내는 신호 
* 쿠버네티스가 컨테이너를 멈추기로 결정할 때마다 컨테이너는 시그텀 신호 수신  
* 시그텀신호를 받자마자 종료/ 진행 중인 요청 완료 → 연결 해제 → 임시파일 삭제 후 종료 등 다양  

- - - -
## 2. 시그킬 신호 - SIGKILL
* 즉시 종료 신호  
* 시그텀 신호 수신 후에 컨테이너 프로세스가 종료되지 않으면 보내는 신호- 시그킬 신호에 의해 컨테이너는 강제 종료됨  
* .spec.terminationGracePeriodSeconds 필드를 사용해 개별 파드마다 유예시간(시그텀 신호 수신 후 얼마 후에 시그킬 신호 보낼 것인지) 정의 가능하지만 쿠버네티스 명령이 실행되는 동안 재정의 될 수 있어 보장 불가  

- - - -
## 3. 시작 후 훅 - postStart
* 수명주기 관리를 위해 프로세스 신호만 사용하면 제한적이기 때문에 훅 사용  
* postStart 명령은 컨테이너가 생성된 후 주 컨테이너 프로세스와 비동기적으로 실행됨  
* blocking 호출, postStart 핸들러가 완료될 때까지는 컨테이너 상태가 대기 상태로 남아있고 파드는 보류(Pending)상태를 유지함  

### 목적  
1. 컨테이너 프로세스의 초기화 시간을 벌기 위해 컨테이너의 시작 상태를 지연시키는 데 사용  
2. 또는 파드가 어떤 전제조건을 충족하지 못했을 때 컨테이너가 시작되지 않게 함

### 훅 호출 매커니즘 
상태 점검 패턴과 유사하게 핸들러타입 지원  
1. exec : 컨테이너 안에서 직접적으로 명령어 실행  
2. httpGet : 하나의 파드 컨테이너에 의해 공개된 포트로 http GET 요청 수행  

### 주의
1. postStart 실행 보장 X → 중요한 로직 실행시 주의  
2. 훅은 컨테이너 프로세스와 병렬로 실행되기 때문에 컨테이너가 시작되기 전에 훅 실행 가능  
3. 훅은 최소 한 번 실행의 의미로 설계 → 중복 실행 가능  
4. 핸들러에 도달하지 못한 실패한 http 요청에 대해서 재시도 X

- - - -
## 4. 종료 전 훅 - preStop
* 컨테이너가 종료되기 전 컨테이너로 전송되는 블록킹 호출(=시그텀 신호)  
* 시그텀 알림을 트리거 하기 전에 완료되어야 함(시그텀 알림 → 컨테이너 런타임이 컨테이너 삭제를 호출 → 시그텀 알림을 트리거 전에 완료되어야함)

### 훅 호출 매커니즘 
상태 점검 패턴과 유사하게 핸들러타입 지원  
1. exec : 컨테이너 안에서 직접적으로 명령어 실행  
2. httpGet : 하나의 파드 컨테이너에 의해 공개된 포트로 http GET 요청 수행  

### 주의
1. preStop이 블로킹 되거나, 계속 진행중이거나, 실패한 결과가 리턴되더라도, 컨테이너 삭제 또는 프로세스 종료 가능 

- - - -
## 5. 그 밖의 수명주기 제어
* 컨테이너 레벨이 아닌 파드 레벨에서 또 다른 메커니즘으로 초기화 명령어 수행 가능  

### 초기화 컨테이너  
* 일반 컨테이너와 달리 순차적으로 실행되고, 완료될 때까지 실행되며, 파드 내의 애플리케이션 컨테이너가 시작되기 전에 실행됨 → 파드레벨 초기화 작업에 사용 가능  
* 종료 작업 기능 X
* 컨테이너를 사용해 워크플로우 같은 순차적 작업 수행
* 작업 실행을 위해 컨테이너 재사용
* 수명주기 훅은 컨테이너 레벨에서, 초기화 컨테이너는 파드 레벨에서 서로 보완하여 사용 가능  

- - - -
## 정리
클라우드 네이티브 플랫폼은 애플리케이션이 신뢰성 있게 예측 가능한 범위 내에서 실행하고 확장 가능하게 제약과 보장된 기능 제공
* 애플리케이션 수명주기는 플랫폼에 의해 완전 자동화 되어야함






