# 정상 상태 점검(Health Probe Pattern)

## 개요

애플리케이션이 쿠버네티스와 정상 사앹 여부를 통신하는 방법에 관한 패턴

- 애플리케리션 실행 여부
- 요청 처리 준비 상태

파드의 수명주기 관리 및 트래픽이 애플리케이션으로 라우팅되는 방식에 영향을 줌



## 문제

### 기본 컨테이너 재시작

- 프로세스 상태 주기적 확인  -> 애플리케이션이 행이 걸리더라도 확인 불가능

- ex) OutOfMemory 상태이더라도 Java 프로세스 실행중, 무한루프, 교착상태, 스래싱(캐시/힙/프로세스)

- 헬스 체크를 위한 방법 필요

### 해결책

#### 프로세스 정생상태 확인(Process Health Check)

- Kubelet이 컨테이너 프로세스에 대해 지속적으로 수행

#### 라이브니스 점검

- 주기적으로 수행됨
- 애플리케이션 교착상태시 라이브니스(생존상태) 점검
- 애플리케이션 워치독이 장애보고를 못할 수 있음 -> 외부에서 확인 수행이 필요
- 통과하지 못하면 컨테이너를 재시작 -> 시작할 수 없는 경우 근본적인 해결 필요
- 확인 유형
  - HTTP 점검: 컨테이너 IP 주소에 GET 요청, 200~399 사이의 코드 반환시 정상
  - TCP 소켓 점검: 성공적 TCP 연결 가정
  - Exec 점검: 커널 네임스페이스에 임의의 명령 실행 및 정상 종료코드(0) 반환

#### 레디니스 점검

- 주기적으로 수행됨
- 라이브니스: 비정상을 죽이고 새로운 컨테이너 대체
- 컨테이너 재시작이 도움이 안되는 경우 레디니스 점검 적용
- 컨테이너가 시작중이어서 요청을 처리할 준비가 안됐을 경우 또는 컨테이너를 과부하/지연시간/다른 부하로부터 보호가 필요할 때 -> 컨테이너에게 시작할 수 있는 시간 제공
- 점검 방법은 라이브니스 점검과 동일(HTTP/TCP/Exec)
- 장애조치: 서비스 엔드포인트에서 제거되고 새로운 트래픽 **수신 불가**

#### 정상상태 점검을 위한 애플리케이션 프레임워크

- 스프링 액추에이터 <sup>Spring Actuator </sup>
- 와일드플라이 스웜<sup>Wildfly Swarm</sup>
- 카라프<sup>Karaf</sup> 정상상태 확인
- 자바 마이크로프로파일 스펙<sup>MicroProfile Spec</sup>

## 정리

- 완전 자동화를 위해 정상 상태 점검을 위한 수단 제공 필요
  - 정상상태 읽기/해석/조치활동
- 배포/자가치유/스케일 등과 같은 자동화 활동 안에서 기본 역할 수행



### 추가적인 가시성 제공하기

#### 로깅

- 컨테이너가 중요한 이벤트를 시스템 밖으로 보냄
- 시스템 에러 로깅
- 추후 분석을 위해 중앙 수집
- 알람 발생 및 추가 조사를 위해 쓰임
- 사후분석과 가시성 확보
- 컨테이너가 종료되는 이유를 /dev/termination-log에 남기는것이 좋음

### 컨테이너 관측성 옵션

- 컨테이너
  - 프로세스 상태<sup>Health</sup>
  - 프로세스 메트릭
  - 프로세스 로그
- API: 정상상태 확인을 위한 최소한의 API를 반드시 제공해야 함
  - 트레이싱
  - 레디니스
  - 라이브니스
- 트레이싱 및 메트릭 수집 라이브러리와 통합
  - 프로메테우스
  - 오픈트레이싱
